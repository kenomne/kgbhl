import { Router } from 'express';import db from '../db.js';import nodemailer from 'nodemailer';const router=Router();router.post('/',async (req,res)=>{const{name,email,message}=req.body||{};if(!message)return res.status(400).json({error:'message required'});const ip=req.headers['x-forwarded-for']?.split(',')[0]?.trim()||req.socket.remoteAddress;const user_agent=req.headers['user-agent']||'';const stmt=db.prepare('INSERT INTO contact_messages (name, email, message, ip, user_agent) VALUES (?,?,?,?,?)');stmt.run([name||null,email||null,message,ip,user_agent],function(err){if(err)return res.status(500).json({error:'Database error'});res.status(201).json({id:this.lastID,ok:true});});try{if(process.env.SMTP_HOST&&process.env.SMTP_USER&&process.env.SMTP_PASS&&process.env.SMTP_TO){const transport=nodemailer.createTransport({host:process.env.SMTP_HOST,port:parseInt(process.env.SMTP_PORT||'587',10),secure:false,auth:{user:process.env.SMTP_USER,pass:process.env.SMTP_PASS}});await transport.sendMail({from:process.env.SMTP_FROM||'no-reply@example.com',to:process.env.SMTP_TO,subject:'New contact message',text:`From: ${name||'-'} <${email||'-'}>\n\n${message}`});}}catch(e){console.error('Email notification failed:',e.message);}});export default router;